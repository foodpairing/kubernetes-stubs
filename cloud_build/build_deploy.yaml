steps:
- id: "Check secrets"
  secretEnv: ['GEMFURY_PUSH_TOKEN']
  name: python:3.7
  entrypoint: sh
  dir: .
  args:
  - -ec
  - |
    if [ -z "$$GEMFURY_PUSH_TOKEN" ]; then
      echo "ERROR: GemFury push token not found in GCP SecretManager. Exiting"
      exit 11
    fi
    echo "All secrets present"
    echo Gemfury push token is $$GEMFURY_PUSH_TOKEN | sed -e  's/.....$/*****/'
- name:  python:3.7
  id: "Build and Push to GemFury"
  secretEnv: ['GEMFURY_PUSH_TOKEN']
  entrypoint: bash
  args:
  - -ec
  - |
    gemfury_token=$(printf "%s" "$$GEMFURY_PUSH_TOKEN")
    gemfury_url=https://repo.fury.io/$gemfury_token/foodpairing
    pip install poetry
    poetry build -f sdist
    cd dist
    package="$(ls -c *.tar.gz | head -n 1)"
    curl -F package=@$package $gemfury_url
availableSecrets:
  secretManager:
  - versionName: projects/fp-cloud-build/secrets/gemfury-push-token/versions/latest
    env: 'GEMFURY_PUSH_TOKEN'
